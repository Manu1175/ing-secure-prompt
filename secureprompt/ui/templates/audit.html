<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>SecurePrompt · Audit Trail</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://unpkg.com/@picocss/pico@1.5.10/css/pico.min.css" rel="stylesheet">
  <style>
    body{padding:1.2rem} header{display:flex;align-items:center;gap:1rem;margin-bottom:1rem}
    .chips{display:flex;flex-wrap:wrap;gap:.25rem}.chip{font-size:.75rem;background:#eef;border-radius:999px;padding:.1rem .5rem}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    .muted{color:#667}.nowrap{white-space:nowrap}.warn{color:#b55} details pre{max-height:40vh;overflow:auto}
    .toolbar{margin-left:auto;display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
    .btn-xs{font-size:.75rem;padding:.25rem .5rem}
    dialog#descrub-modal{border:none;border-radius:.5rem;box-shadow:0 10px 30px rgba(0,0,0,.2);max-width:34rem}
    #dm-original{max-height:40vh;overflow:auto;white-space:pre-wrap}
    #descrub-result{max-height:40vh;overflow:auto}
  </style>
</head>
<body>
<main id="audit-root" data-descrub-roles="{{ ','.join(descrub_roles or ['auditor']) }}">
<header>
  <h3 style="margin:0">Audit Trail</h3>
  <label>Limit <input id="limit" type="number" min="1" value="100" style="width:7rem"></label>
  <label>Filter <input id="filter" type="search" placeholder="label:EMAIL role:reviewer endpoint:/scrub …"></label>
  <div class="toolbar">
    <a href="/audit/jsonl" class="secondary">Download JSONL</a>
    <label>Role <input id="role-input" type="text" value="reviewer" style="width:8rem"></label>
    <button id="clear" class="secondary" title="Clear filter">Clear</button>
    <button id="refresh" class="contrast">Refresh</button>
  </div>
</header>

<div id="summary" style="margin:.5rem 0 1rem 0; display:none">
  <small class="muted">Summary:&nbsp;
    <span id="sum-receipts"></span>, <span id="sum-entities"></span>&nbsp;·&nbsp;
    <span id="sum-actions"></span>&nbsp;·&nbsp;
    <span id="sum-latency"></span>
  </small>
</div>

<article id="empty" class="warn" style="display:none">
  No audit entries yet. Scrub text or files to populate the log.
</article>

<table role="grid">
  <thead>
    <tr><th class="nowrap">Time</th><th>Actor</th><th>Endpoint</th><th>C-level</th><th>Entities</th><th>Hashes</th><th>More</th></tr>
  </thead>
  <tbody id="rows"></tbody>
</table>

  <dialog id="descrub-modal">
    <article>
      <header style="display:flex;align-items:center;justify-content:space-between;gap:.5rem">
        <strong>De-scrub Result</strong>
        <button id="descrub-close" class="secondary">Close</button>
      </header>
      <pre id="descrub-modal-text" class="mono" style="max-height:40vh;overflow:auto;white-space:pre-wrap"></pre>
    </article>
  </dialog>

<script>
const $ = s => document.querySelector(s);
const rows = $("#rows"), empty = $("#empty");
const limitI = $("#limit"), filterI = $("#filter"), btn = $("#refresh"), clearBtn = $("#clear");

const chip = s => `<span class="chip">${s}</span>`;
const esc = s => String(s||'').replace(/[&<>\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const fmtTs = ts => { try{ return new Date(ts).toLocaleString(); }catch{ return ts||''; } };
// ---- robust timestamp parser (handles ISO string or number) ----
const tsNum = (x) => {
  const v = x?.ts ?? x?.timestamp ?? x?.time ?? x?.ts_ms ?? null;
  if (typeof v === 'number') return v;
  const n = Date.parse(v);
  return Number.isFinite(n) ? n : 0;
};

function normalizeResponse(data){
  if (Array.isArray(data)) return data;
  if (data && Array.isArray(data.items)) return data.items;
  if (data && typeof data==='object'){
    for(const k of Object.keys(data)) if(Array.isArray(data[k])) return data[k];
  }
  return [];
}
function matchesFilter(item, q){
  if (!q) return true;
  const terms=q.trim().split(/\s+/), flat=JSON.stringify(item).toLowerCase();
  for (const t of terms){
    if (!t) continue;
    if (t.includes(':')){
      const [k,v]=t.toLowerCase().split(':');
      const cand=(item[k] ?? item.actor?.[k] ?? item.policy?.[k] ?? item.client?.[k] ?? item.counts?.[k] ?? '');
      if (String(cand).toLowerCase().indexOf(v)===-1) return false;
    } else if (flat.indexOf(t.toLowerCase())===-1){
      return false;
    }
  }
  return true;
}
function entityChips(ents){
  if (!Array.isArray(ents)||!ents.length) return '<span class="muted">–</span>';
  const by={};
  for (const e of ents){
    const k=(e.label||'').toString().toUpperCase();
    by[k]=(by[k]||0)+1;
  }
  return '<div class="chips">'+Object.entries(by).map(([k,v])=>chip(`${k} ×${v}`)).join('')+'</div>';
}
function row(item){
  const ents=item.entities||[];
  const tsLabel=fmtTs(item.ts);
  const lh=(item.original_hash||'').slice(0,12), sh=(item.scrubbed_hash||'').slice(0,12);
  const op=item.operation_id ? `<div class="mono">op: <span class="opid">${esc(item.operation_id)}</span></div>` : '';
  const role=item.role ? `<div class="muted">role: ${esc(item.role)}</div>` : '';
  const just=item.justification ? `<div class="muted">just: ${esc(item.justification)}</div>` : '';
  const endpointRaw=item.endpoint||'';
  const endpoint=esc(endpointRaw);
  const actor=esc(item.actor||item.actor_name||'');
  const ip=esc(item.client_ip||item.client?.ip||'');
  const clevel=esc(item.c_level||item.policy?.clearance||'—');

  const showBtn = (item.endpoint==="/scrub" && item.operation_id);
  const descrubBtn = showBtn ? `<button class="secondary outline descrub-btn" data-op="${esc(item.operation_id)}" style="display:none">De-scrub</button>` : '';
  const inlineHost = showBtn ? `<div class="descrub-inline" data-inline-for="${esc(item.operation_id)}"></div>` : '';

  return `
    <tr>
      <td class="nowrap">${esc(tsLabel)}</td>
      <td><div>${actor||'—'}</div><div class="muted">${ip}</div></td>
      <td>
        <div class="mono">${endpoint}</div>${op}${role}${just}
      </td>
      <td>${clevel}</td>
      <td>${entityChips(ents)}</td>
      <td class="mono"><div>orig: ${lh||'—'}</div><div>scrb: ${sh||'—'}</div></td>
      <td>
        <details><summary>JSON</summary>
          <div style="display:flex;align-items:center;gap:.5rem;margin:.5rem 0">
            <a class="json-link" data-op="${esc(item.operation_id||'')}" href="#">JSON</a>
            ${descrubBtn}
          </div>
          ${inlineHost}
          <pre class="mono">${esc(JSON.stringify(item,null,2))}</pre>
        </details>
      </td>
    </tr>`;
}

async function loadSummary(){
  try{
    const r = await fetch('/metrics');
    if(!r.ok){
      $("#summary").style.display='none';
      return;
    }
    const data = await r.json();
    const actions = data.by_action_no_unknown || {};
    const chips = Object.entries(actions)
      .map(([k,v]) => chip(`${k} ×${v}`))
      .join(' ');

    $("#sum-receipts").textContent = `receipts: ${data.receipts || 0}`;
    $("#sum-entities").textContent = `entities: ${data.entities || 0}`;
    $("#sum-actions").innerHTML = chips || '<span class="muted">no actions yet</span>';

    const p50 = data?.latency_ms?.p50 ?? 0;
    const p90 = data?.latency_ms?.p90 ?? 0;
    $("#sum-latency").textContent = `p50 ${p50}ms · p90 ${p90}ms`;

    $("#summary").style.display='block';
  }catch{
    $("#summary").style.display='none';
  }
}

async function load(){
  rows.innerHTML = '<tr><td colspan="7">Loading…</td></tr>';
  empty.style.display='none';
  const limit = Number(limitI.value)||100;
  const res = await fetch(`/audit?limit=${limit}&_=${Date.now()}`);
  if (!res.ok){ rows.innerHTML = `<tr><td colspan="7" class="warn">Error ${res.status}: cannot fetch /audit</td></tr>`; return; }
  const items = normalizeResponse(await res.json()).filter(i=>matchesFilter(i, filterI.value));
  items.sort((a, b) => tsNum(b) - tsNum(a));
  if (!items.length){ rows.innerHTML=''; empty.style.display='block'; return; }
  rows.innerHTML = items.map(row).join('');
  updateRowButtons();
}

const root = document.getElementById('audit-root');
const allowed = (root?.dataset.descrubRoles || 'auditor')
  .split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
const roleInput = document.getElementById('role-input');

function updateRowButtons(){
  const role = (roleInput?.value || '').trim().toLowerCase();
  const show = allowed.includes('auditor') && role === 'auditor';
  document.querySelectorAll('.descrub-btn').forEach(b => { b.style.display = show ? '' : 'none'; });
}

document.addEventListener('DOMContentLoaded', updateRowButtons);
roleInput?.addEventListener('input', updateRowButtons);

const modal = document.getElementById('descrub-modal');
const modalText = document.getElementById('descrub-modal-text');
document.getElementById('descrub-close')?.addEventListener('click', (e)=>{
  e.preventDefault();
  modal?.close?.();
});

function openModalWith(text){
  if (modalText) modalText.textContent = text || '(no original payload)';
  if (modal && typeof modal.showModal === 'function') {
    modal.showModal();
  } else {
    alert(text || '(no original payload)');
  }
}

const cssEscape = (window.CSS && CSS.escape) ? CSS.escape : (s => String(s).replace(/["\\]/g,'\\$&'));

document.addEventListener('click', async (ev)=>{
  const btn = ev.target.closest('.descrub-btn');
  if (!btn) return;
  ev.preventDefault();
  const op = btn.dataset.op;
  if (!op) return;
  let just = window.prompt('Justification (required):', '') || '';
  just = just.trim();
  if (just.length < 5) {
    alert('Please enter at least 5 characters.');
    return;
  }
  btn.disabled = true;
  try{
    const res = await fetch(`/descrub/${encodeURIComponent(op)}?role=auditor&just=${encodeURIComponent(just)}`);
    const data = await res.json();
    if (!res.ok){
      alert(data?.detail ? `De-scrub failed: ${data.detail}` : `De-scrub failed (${res.status})`);
      return;
    }
    const original = data.original ?? data.descrubbed ?? '';
    const host = document.querySelector(`.descrub-inline[data-inline-for="${cssEscape(op)}"]`);
    if (host) {
      const escHtml = s => String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
      host.innerHTML = `<details open><summary>Original (de-scrub)</summary><pre class="mono">${escHtml(original)}</pre></details>`;
    }
    openModalWith(original);
  }catch(err){
    alert(`De-scrub failed: ${err}`);
  } finally {
    btn.disabled = false;
  }
});

btn.addEventListener('click', ()=>{ loadSummary(); load(); });
filterI.addEventListener('keydown', e=>{ if(e.key==='Enter') load(); });
clearBtn.addEventListener('click', ()=>{
  filterI.value='';
  load();
});
loadSummary();
load();
</script>
</main>
</body>
</html>
